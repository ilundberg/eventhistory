---
title: "Data"
format:
  html:
    toc: true
    toc-expansion: true
    fig-height: 3
---

```{r, echo = F, message = F, warning = F}
library(tidyverse)
library(survival)
library(foreach)
```

This page is a reference for several datasets that we use in the course.

## Four life outcomes

The file [assets/nlsy_outcomes.csv](nlsy_outcomes.csv) contains data from the [NLSY97](https://www.bls.gov/nls/nlsy97.htm) cross-sectional sample (excluding oversamples). Each person (indexed by `id`) has four rows corresponding to four outcomes: high school completion, BA completion, marriage, and first birth.

-   `id` is the person identifier
-   `sex` is a covariate from the baseline interview
-   `race` is a covariate from the baseline interview
-   `outcome` is the outcome that the row summarizes: `educ_hs` for high school completion, `educ_ba` for college, `married` for first marriage, and `parent` for first birth
-   `time` is the age in years at which the outcome occurs, or the unit is censored
-   `censored` is an indicator variable coded `FALSE` if the outcome occurs and `TRUE` if the unit was censored: the last interview happened without the event occurring. For units with `censored = TRUE`, the `time` variable is the age at the last interview.

```{r, eval = F}
nlsy_outcomes <- read_csv("https://ilundberg.github.io/eventhistory/assets/nlsy_outcomes.csv")
```

```{r, echo = F, message = F, warning = F}
nlsy_outcomes <- read_csv("assets/nlsy_outcomes.csv")
```

When analyzing these data, you should first filter the data to a single value of `outcome` that you plan to study. The figure below shows Kaplan-Meier survival curves for these four outcomes.

```{r, echo = FALSE}
foreach(outcome_value = c("educ_hs","educ_ba","married","parent"), .combine = "rbind") %do% {
  survfit(
    Surv(time, event = 1 - censored) ~ 1, 
    data = nlsy_outcomes |> filter(outcome == outcome_value)
  ) |>
    broom::tidy() |>
    mutate(outcome = outcome_value)
} |>
  ggplot(aes(x = time, y = estimate)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(~outcome, labeller = as_labeller(\(x) case_when(
    x == "educ_hs" ~ "High School Degree\n(educ_hs)",
    x == "educ_ba" ~ "4-Year College Degree\n(educ_ba)",
    x == "married" ~ "First Marriage\n(married)",
    x == "parent" ~ "First Birth\n(parent)"
  ))) +
  labs(y = "Survival: Probability of\nNot Yet Having Event", x = "Time (Age in Years)")
```

## Employment duration

This dataset can be used to model the duration of an employment spell as a function of covariates defined at the beginning of the spell.

The file [assets/employment_duration.csv](employment_duration.csv) contains data from the [NLSY97](https://www.bls.gov/nls/nlsy97.htm) cross-sectional sample (excluding oversamples). Each row is a (person $\times$ employment spell). Variables are defined as follows:

-   `id` is a person identifier
-   `time` is the duration of the employment spell in years. It begins with the month a respondent moves from being non-employed to being employed at least one week. It ends with the month a respondent becomes non-employed again for an entire month.
-   `censored` is an indicator for being censored, coded `TRUE` if the last interview occurred during this employment spell and `FALSE` if the end of the employment spell was observed
-   Two covariates are defined at the baseline survey: `sex` and `race`
-   Four covariates are defined at the start of the employment spell: `age`, `education`, `marital`, and `parent` (whether the respondent is a parent)

```{r, eval = F}
employment_duration <- read_csv("https://ilundberg.github.io/eventhistory/assets/employment_duration.csv")
```

```{r, echo = F, message = F, warning = F}
employment_duration <- read_csv("assets/employment_duration.csv")
```

The figure below shows a Kaplan-Meier survival curve for first marriage duration in these data.

```{r, echo = F}
survfit(
  Surv(time, event = 1 - censored) ~ 1, 
  data = employment_duration
) |>
  broom::tidy() |>
  ggplot(aes(x = time, y = estimate)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(y = "Survival: Probability of\nRemaining Employed", x = "Time (Age in Years)")
```

## First marriage duration

This dataset can be used to model the duration of a first marriage as a function of covariates defined at the beginning of the marriage. It can also be used to reason about competing risks, because marriages end for several reasons recorded in the `how_end` variable.

The file [assets/first_marriage_duration.csv](first_marriage_duration.csv) contains data from the [NLSY97](https://www.bls.gov/nls/nlsy97.htm) cross-sectional sample (excluding oversamples). Each row is a person who reports the start of a first marriage.

-   `id` is a person identifier
-   `censored` is an indicator for being censored, coded `TRUE` if the last interview occurred while the respondent was still married and `FALSE` if otherwise (i.e., end of marriage was observed)
-   `time` is the duration of the first marriage in years, until either the end of the marriage or censoring
-   `how_end` is how the marriage ended: `Censored`, `Divorced`, `Legally Separated`, or `Widowed`
-   Two covariates are defined at the baseline survey: `sex` and `race`
-   Three covariates are defined at the start of the first marriage: `age`, `education`, and `parent` (whether the respondent is a parent)

```{r, eval = F}
first_marriage_duration <- read_csv("https://ilundberg.github.io/eventhistory/assets/first_marriage_duration.csv")
```

```{r, echo = F, message = F, warning = F}
first_marriage_duration <- read_csv("assets/first_marriage_duration.csv")
```

The figure below shows a Kaplan-Meier survival curve for first marriage duration in these data.

```{r, echo = F}
survfit(
  Surv(time, event = 1 - censored) ~ 1, 
  data = first_marriage_duration
) |>
  broom::tidy() |>
  ggplot(aes(x = time, y = estimate)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(y = "Survival: Probability of\nRemaining Married", x = "Time (Age in Years)")
```

## U.S. life table deaths

Using 2023 U.S. age-specific mortality data from an [NCHS report](https://www.cdc.gov/nchs/products/databriefs/db548.htm), I generated deaths for a hypothetical population that experiences these rates, available in [deaths.csv](assets/deaths.csv).

```{r, eval = F}
deaths <- read_csv("https://ilundberg.github.io/eventhistory/assets/deaths.csv")
```

These data include

* `id` indexes simulated persons
* `age` is the time variable
* `died` is whether the person died (`died = 1`) or was censored (`died = 0`)

The figure below visualizes Kaplan-Meier survival estimates in these data.

```{r, echo = FALSE, warning = F, message = F}
deaths <- read_csv(file = "assets/deaths.csv")
survfit(
  Surv(age, event = died) ~ 1, 
  data = deaths
) |>
  broom::tidy() |>
  ggplot(aes(x = time, y = estimate)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(y = "Survival", x = "Age")
```

## Heart recipients

These data come from a medical trial that tracked survival outcomes of patients receiving heart transplants. 

> Crowley, J., & Hu, M. (1977). Covariance analysis of heart transplant survival data. Journal of the American Statistical Association, 72(357), 27-36.

The trail enrolled people eligible for heart transplants, some of whom later received transplants and some did not. The full data are available in the `jasa` data object of the `survival` package. A simplified version of the data focuses on survival outcomes post-transplant for transplant recipients. This simplified file is [heart_recipients.csv](assets/heart_recipients.csv).

```{r, eval = F}
heart_recipients <- read_csv("https://ilundberg.github.io/eventhistory/assets/heart_recipients.csv")
```

In the `heart_recipients` data,

* `t` is time in years from transplant until either death or censoring
* `c` is censoring, coded `TRUE` for censoring and `FALSE` for death
* `age` is the patient's age at the time of transplant

Below is a Kaplan-Meier survival curve with these data.

```{r, echo = F, warning = F, message = F}
heart_recipients <- read_csv("assets/heart_recipients.csv")
survfit(
  Surv(t, event = 1 - c) ~ 1, 
  data = heart_recipients
) |>
  broom::tidy() |>
  ggplot(aes(x = time, y = estimate)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(y = "Survival", x = "Time Since Transplant (Years)")
```

## Justice retirement

These data were originally collected by German Rodriguez ([original source](https://grodri.github.io/survival/justices)). He used Wikipedia and the Supreme Court website to create a dataset on the time that Supreme Court justices were in office, and how their time ended (retirement, resignation, death, still an incumbent).

A simplified version of these data is [retirement.csv](assets/retirement.csv)

```{r, eval = F}
retirement <- read_csv("https://ilundberg.github.io/eventhistory/assets/retirement.csv")
```

These data contain

- `number` indexes Supreme Court justices
- `name` contains names
- `state` contains the justice's home state
- `age_appointed` is the age at which the justice was appointed
- `status` indicates how the term ended (`Resigned`, `Retired`, or `Died`)
- `t` is the total time from appointment until `status`

The graph below shows the cumulative proportion in each status over time.

```{r, echo = F, message = F, warning = F}
library(foreach)
retirement <- read_csv("assets/retirement.csv")
by_years <- foreach(years_val = 1:35, .combine = "rbind") %do% {
  tibble(
    years = years_val,
    active = mean(retirement$t > years_val),
    retired = mean(retirement$t <= years_val & retirement$status == "Retired"),
    resigned = mean(retirement$t <= years_val & retirement$status == "Resigned"),
    died = mean(retirement$t <= years_val & retirement$status == "Died")
  )
}
by_years |>
  pivot_longer(cols = -years, names_to = "status") |>
  ggplot(aes(x = years, y = value, color = status, linetype = status)) +
  geom_line() +
  labs(
    x = "Years Since Appointment",
    y = "Probability of Status",
    color = "Status",
    linetype = "Status",
    title = "Mortality and retirement of Supreme Court justices",
    caption = "The retired status includes those who resigned."
  ) +
  scale_color_discrete(labels = stringr::str_to_sentence) +
  scale_linetype_discrete(labels = stringr::str_to_sentence)
```