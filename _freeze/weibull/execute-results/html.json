{
  "hash": "b75c3dd58f4b7fc01bce16e31b2b0b4a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Weibull\"\nformat:\n  html:\n    toc: true\n    toc-expansion: true\n    fig-height: 3\n---\n\n\n::: {.cell}\n\n:::\n\n\nLike the Exponential, the Weibull is a distribution defined on positive real numbers. The Weibull is commonly used in survival analysis because it produces a hazard function that can increase with time or decrease with time. The Weibull hazard is always monotonic (either always increasing or always decreasing, or flat). The distribution functions in R are `*weibull` with `*` being `d`, `r`, `q`, or `p`.\n\nThese functions parameterize the Weibull with two parameters: shape and scale.\n\nThe shape determines how the hazard function changes with time. Below are Weibull hazards with several `shape` parameters and with fixed `scale = 1`.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nforeach(shape_value = c(.9,1,2,4), .combine = \"rbind\") %do% {\n  tibble(p = seq(.01, .99, .01)) |>\n    mutate(\n      t = qweibull(p, shape = shape_value, scale = 1),\n      f = dweibull(t, shape = shape_value, scale = 1),\n      S = pweibull(t, shape = shape_value, scale = 1, lower.tail = FALSE),\n      h = f / S,\n      shape = shape_value\n    )\n} |>\n  ggplot(aes(x = t, y = h)) +\n  geom_line() +\n  facet_wrap(~shape, scales = \"free\", labeller = as_labeller(\\(x) paste(\"Shape =\",x)), nrow = 1) +\n  labs(\n    x = \"Time\",\n    y = \"Hazard\",\n    title = \"Weibull hazard functions: By shape parameter, at scale = 1\"\n  )\n```\n\n::: {.cell-output-display}\n![](weibull_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nThe `scale` parameter determines the scale of the `time` axis. A longer scale means longer survival times.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nforeach(scale_value = c(.5,1,2), .combine = \"rbind\") %do% {\n  tibble(p = seq(.01, .99, .01)) |>\n    mutate(\n      t = qweibull(p, shape = 4, scale = scale_value),\n      f = dweibull(t, shape = 4, scale = scale_value),\n      S = pweibull(t, shape = 4, scale = scale_value, lower.tail = FALSE),\n      h = f / S,\n      scale = paste0(\"Scale = \",scale_value)\n    )\n} |>\n  ggplot(aes(x = t, y = h)) +\n  geom_line() +\n  facet_wrap(~scale, scales = \"free\") +\n  labs(\n    x = \"Time\",\n    y = \"Hazard\",\n    title = \"Weibull hazard functions: By scale parameter, at shape = 4. Note the x-axis.\"\n  )\n```\n\n::: {.cell-output-display}\n![](weibull_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n## Weibull model\n\nWhen modeling Weibull outcomes as a function of predictors $\\vec{X}$, we will often assume\n\n* the `shape` is the same regardless of $\\vec{X}$\n* the `scale` equals $\\log(\\vec{X}_i\\vec\\beta)$\n\nAs an illustration, we will generate a simulation where survival times differ as a function of a binary predictor $X$,\n\n$$\\begin{aligned}\nX &\\sim \\text{Bernoulli}(0.5) \\\\\nT &\\sim \\text{Weibull}\\left(\\texttt{shape} = \\alpha,\\texttt{scale} = \\exp(\\beta_0 + \\beta_1 X)\\right)\n\\end{aligned}$$\n\nfor $\\alpha = 3$,  $\\beta_0 = 0$, and $\\beta_1 = 2$. Below we set these parameters.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nalpha <- 3\nbeta0 <- 0\nbeta1 <- 1\n```\n:::\n\n\nThen we simulate some data from this process.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimulated <- tibble(id = 1:1e4) |>\n  mutate(\n    x = rbinom(n(), 1, .5),\n    scale = exp(beta0 + beta1 * x),\n    # Simulate from the Weibull\n    t = rweibull(n(), shape = alpha, scale = scale),\n    c = 0\n  )\n```\n:::\n\n\nWe can then fit a Weibull survival model with the `survreg` function,\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- survreg(\n  Surv(t, 1 - c) ~ x,\n  data = simulated,\n  dist = \"weibull\"\n)\n```\n:::\n\n\n::: {.cell}\n\n:::\n\n\nand we can confirm that the estimated parameters match their true values. First, we extract the `shape` parameter $\\hat\\alpha$ which (confusingly) is the inverse of the `scale` element of the fitted model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nalpha_estimate <- 1 / model$scale\n```\n:::\n\n\nThen, we can extract the coefficients $\\hat{\\vec\\beta}$.\n\n::: {.cell}\n\n```{.r .cell-code}\nbeta_estimate <- coef(model)\n```\n:::\n\n\nWe can confirm that these are correct.\n\n::: {.cell}\n\n```{.r .cell-code}\ncbind(\n  truth = c(alpha = alpha, beta0 = beta0, beta1 = beta1), \n  estimate = c(alpha = alpha_estimate, beta_estimate)\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      truth     estimate\nalpha     3  2.966910687\nbeta0     0 -0.001290743\nbeta1     1  1.004828539\n```\n\n\n:::\n:::\n\n\n## Simulate quantities of interest\n\nFinally, we can convert to quantities of interest. For example, what is the estimated survival function from time 0 to 10 in each group?\n\nFirst, define the groups for which to make predictions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nto_predict <- tibble(x = 0:1)\n```\n:::\n\n\nThen, predict the `scale` and `shape` parameters from the model. Note that you can calculate the `scale` parameter manually by extracting $\\hat{\\vec\\beta}$ as we did above, or you can use `predict()` with the argument `type = \"linear\"` to automatically predict the value of the linear predictor $\\vec{X}'\\vec\\beta$ (which is the log of the `scale` parameter, since `scale` = $\\exp(\\vec{X}'\\vec\\beta)$.\n\n::: {.cell}\n\n```{.r .cell-code}\npredicted_parameters <- to_predict |>\n  mutate(\n    shape = 1 / model$scale,\n    log_scale = predict(\n      model, \n      newdata = to_predict, \n      type = \"linear\"\n    ),\n    scale = exp(log_scale)\n  )\n```\n:::\n\n\nAt this point, each row of `predicted_parameters` corresponds to a person. We want to expand to person-periods.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredicted_survival <- predicted_parameters |>\n  group_by(x) |>\n  # Create 100 copies of each line\n  uncount(weights = 100) |>\n  # Create a sequence over the times to predict\n  mutate(\n    time = seq(from = 0.01, to = 4, length.out = 100)\n  ) |>\n  # Calculate the survival probability at that time\n  mutate(\n    S = pweibull(\n      q = time,\n      shape = shape,\n      scale = scale,\n      lower.tail = FALSE\n    )\n  )\n```\n:::\n\n\n::: {.cell}\n\n:::\n\n\nWe can plot those survival curves!\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredicted_survival |>\n  # Make x a character for easier plotting\n  mutate(x = paste(\"x =\",x)) |>\n  ggplot(aes(x = time, y = S, color = x, linetype = x)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](weibull_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n",
    "supporting": [
      "weibull_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}