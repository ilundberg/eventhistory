{
  "hash": "5c96cb9f1df7795a3cc0962cb732f0f3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Proportional Hazards\"\nformat:\n  html:\n    toc: true\n    toc-expansion: true\n    fig-height: 3\n---\n\n\n::: {.cell}\n\n:::\n\n\nThe Exponential and Weibull models we have already learned are examples of **proportional hazards models**. These models begin with a **baseline hazard** that applies when $\\vec{X} = \\vec{0}$. For other values of $\\vec{X}$, the hazard equals the baseline hazard multiplied by **hazard ratio** $e^{\\vec{X}'\\vec\\beta}$.\n\n$$\nh(t\\mid\\vec{X}) = \\underbrace{\\lambda(t)}_{\\substack{\\text{baseline}\\\\\\text{hazard}}}\\underbrace{e^{\\vec{X}'\\vec\\beta}}_{\\substack{\\text{hazard}\\\\\\text{ratio}}}\n$$\n\nLet's see proportional hazards in a concrete example. On the Weibull page, we created an object `predicted_survival` containing the predicted values of a survival curve. Below, we load this object again.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredicted_survival <- read_csv(\"assets/predicted_survival_weibull.csv\")\n```\n:::\n\n\nRecall that this object has two units with `x = 0` and `x = 1`, with many rows per unit representing survival probabilities at each time point. We can calculate the hazard at these time points as well.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredicted_hazard <- predicted_survival |>\n  mutate(\n    # Calculate the PDF at each point\n    f = dweibull(x = time, shape = shape, scale = scale),\n    # Hazard equals PDF over survival\n    h = f / S\n  )\n```\n:::\n\n\nBelow we visualize these hazard functions. The hazard in population subgroup $X = 0$ is much higher than the hazard in subgroup $X = 1$, at every time point.\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\npredicted_hazard |>\n  select(x, time, h) |>\n  ggplot(aes(x = time, y = h, color = factor(x), linetype = factor(x))) +\n  geom_line() +\n  labs(\n    y = \"Hazard Function\", \n    x = \"Time\", \n    color = \"Population\\nSubgroup (X)\",\n    linetype = \"Population\\nSubgroup (X)\"\n  )\n```\n\n::: {.cell-output-display}\n![](proportional_hazards_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nNext, consider the **hazard ratio** at each time $t$: the hazard in group $X = 1$ divided by the hazard in group $X = 0$.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\npredicted_hazard_ratios <- predicted_hazard |>\n  select(x, time, h) |>\n  pivot_wider(names_from = \"x\", values_from = \"h\", names_prefix = \"hazard_if_x_\") |>\n  mutate(hazard_ratio = hazard_if_x_1 / hazard_if_x_0) |>\n  print(n = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 100 × 4\n    time hazard_if_x_0 hazard_if_x_1 hazard_ratio\n   <dbl>         <dbl>         <dbl>        <dbl>\n1 0.01        0.000347     0.0000176       0.0507\n2 0.0503      0.00832      0.000422        0.0507\n3 0.0906      0.0265       0.00134         0.0507\n4 0.131       0.0546       0.00277         0.0507\n5 0.171       0.0926       0.00470         0.0507\n# ℹ 95 more rows\n```\n\n\n:::\n:::\n\n\nNote that the hazard ratio is **constant** in this model. The hazard ratio is 0.0507 at every time point. A hazard ratio that is constant over time is the hallmark of a proportional hazards model: the hazard function at every $\\vec{x}$ value is proportional to a **baseline hazard** that exists if $\\vec{x} = \\vec{0}$.\n\n## Math for Exponential and Weibull PH\n\nHere we use math to see the Exponential and Weibull models as proportional hazards models.\n\n### Exponential PH in math\n\nFor the Exponential model $T\\sim\\text{Exponential}(\\lambda)$ with where we model the rate parameter $\\lambda = \\exp(\\beta_0 + \\beta_1 X)$, the hazard function is $h(t) = \\lambda = \\exp(\\beta_0 + \\beta_1 X)$. The baseline hazard when $X = 0$ is $\\exp(\\beta_0)$, and the hazard when $X = 1$ is $\\exp(\\beta_0 + \\beta_1)$. The hazard ratio for $X = 1$ vs $X = 0$ is $\\exp(\\beta_1)$.\n\n### Weibull PH in math\n\nFor a Weibull with shape $\\alpha$ and scale $\\sigma$, the probability density function is\n$$\nf(t) = \\alpha \\sigma ^ {-\\alpha} t^{\\alpha-1}e^{-(\\frac{1}{\\sigma} t)^\\alpha}\n$$\nand the survival function is\n$$\nS(t) = e^{-(\\frac{1}{\\sigma} t)^{\\alpha}}\n$$\nTaking the ratio, the hazard function is\n\n$$\nh(t) = \\alpha \\sigma ^ {-\\alpha} t^{\\alpha-1}\n$$\n\nWhen using the `survreg` function in the `survival` package, we model $\\sigma = \\exp(\\beta_0 + \\beta_1 X)$. Plugging this in, we can see how the Weibull hazard function is proportional across values of $X$.\n\n$$\n\\begin{aligned}\nh(t) &= \\alpha \\left(e^{\\beta_0 + \\beta_1 X}\\right) ^ {-\\alpha} t^{\\alpha-1} \\\\\n&= \\underbrace{\\alpha e^{-\\alpha\\beta_0}t^{\\alpha - 1}}_{\\substack{\\text{baseline}\\\\\\text{hazard}}}\\underbrace{e^{\\beta_1 X}}_{\\substack{\\text{hazard}\\\\\\text{ratio}}} \\\\\n&= \\begin{cases}\n  \\alpha e^{-\\alpha\\beta_0}t^{\\alpha - 1} &\\text{if }x=0 \\\\\n  \\alpha e^{-\\alpha\\beta_0}t^{\\alpha - 1}e^{-\\alpha\\beta_1} &\\text{if }x=1 \n\\end{cases}\n\\end{aligned}\n$$\n\nWe can confirm that this hazard ratio is correct in the fitted model (see the Weibull page for fitting this model).\n\n\n::: {.cell}\n\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- readRDS(\"https://ilundberg.github.io/eventhistory/assets/weibull_model.RDS\")\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nalpha_hat <- 1 / model$scale\nbeta1_hat <- coef(model)[2]\nhazard_ratio <- exp(- alpha_hat * beta1_hat)\n```\n:::\n\n\nThe resulting hazard ratio 0.0507 is equal to the one we calculated from predicted values 0.0507. Thus, our mathematical understanding of the Weibull proportional hazards model aligns with the predicted values from the canned output.\n\n",
    "supporting": [
      "proportional_hazards_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}