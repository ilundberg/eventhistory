{
  "hash": "cf49491887b2a82a70cca69464cf2951",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"MSM with One Treatment Period\"\nformat:\n  html:\n    toc: true\n    toc-expansion: true\n---\n\n\n::: {.cell}\n\n:::\n\n\nMarginal structural modeling is a general tool for estimating causal effects under selection on observables. A marginal structural model (MSM) separates two steps:\n\n* use weights to address confounding\n* use a model for $Y^a$ to pool information across treatment values\n\nThis page introduces this idea with a focus on survival outcome modeling for time-to-event data in the presence of ignorable censoring.\n\n## Concept of weighting\n\nConsider a person $i$ who receives treatment with probability $\\text{P}(A = 1\\mid \\vec{X} = \\vec{x}_i) = 20\\%$. We can think about 5 people who are observationally identical to person $i$ (with $\\vec{X} = \\vec{x}_i$). The 20\\% probability means that in expectation one of these people is treated and 4 others are not. If person $i$ is treated, we might say they represent a total of 5 people. We could calculate that probability by taking the inverse of the probability of treatment: $\\frac{1}{0.2} = 5$. This is the intuition of **inverse probability of treatment weighting**.\n\nMore generally, define a function that takes a treatment value $a$ and confounder vector $\\vec{x}$ and returns an inverse probability of treatment weight.\n\n$$\nw(a,\\vec{x}) = \\frac{1}{\\text{P}(A = a \\mid\\vec{X} = \\vec{x})}\n$$\n\nThe weight $w(a,\\vec{x})$ answers the question: if I see a person $i$ with $A_i = a$ and I want to study a counterfactual pseudo-population in which everyone receives treatment value $a$, how many people does person $i$ represent?\n\n## Sample estimator by weighting\n\nFor average potential outcomes in the absence of censoring, the weight function yields a weighting estimator,\n\n$$\n\\hat{\\text{E}}\\left(Y^a\\right) = \\frac{\\sum_{i:A_i=a} Y_i w(A_i,\\vec{X}_i)}{\\sum_{i:A_i=a}w(A_i,\\vec{X}_i)}\n$$\n\nwhich is the weighted sample mean of $Y_i$ among the units with $A_i = a$.\n\n## Weighting for survival outcomes\n\nFor survival outcomes, the formula above may not be useful because there exists censoring. If $Y$ is time to (event) and $\\tilde{Y}\\leq Y$ is time to (event or censoring), then any summary of the observable $\\tilde{Y}$ will be downwardly biased for the corresponding summary of event times $Y$. This is why we need a survival model.\n\nMarginal structural models ([Hernan et al. 2001](https://doi.org/10.1198/016214501753168154)) generalize the weighting idea to settings where an outcome model is necessary. The approach proceeds in several steps:\n\n1. Model treatment assignment $\\text{P}(A\\mid\\vec{X})$\n2. Construct inverse probability of treatment weights $w(A_i,\\vec{X}_i)$ for each $i$\n     * Note that the treatment value $A_i$ is whatever treatment value was observed for unit $i$\n3. Model the outcome $Y_i$ as a function of $A_i$, weighted by $w(A_i,\\vec{X}_i)$\n4. Predict quantities of interest\n\n## Worked example\n\nTry sketching out these steps for the `veteran` example before looking at the code below.\n\n1. **Model treatment** assignment $\\text{P}(A\\mid\\vec{X})$\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nmodel_treatment <- glm(\n  I(trt == 2) ~ karno + diagtime + age + prior,\n  data = veteran,\n  family = binomial()\n)\n```\n:::\n\n\n2. **Construct weights** by the inverse probability of treatment\n     * Note that the treatment value $A_i$ is whatever treatment value was observed for unit $i$\n     \n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nweighted <- veteran |>\n  mutate(\n    p_treated = predict(model_treatment, type = \"response\"),\n    p_control = 1 - p_treated,\n    weight = case_when(\n      trt == 1 ~ 1 / p_control,\n      trt == 2 ~ 1 / p_treated\n    )\n  )\n```\n:::\n\n     \n3. **Model outcome** values $Y_i$ as a function of $A_i$, weighted by $w(A_i,\\vec{X}_i)$. This is your marginal structural model.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Code answer using Weibull.\"}\nmodel_outcome <- survreg(\n  Surv(time, status) ~ trt,\n  data = weighted,\n  weights = weight\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Code answer using Kaplan-Meier.\"}\nmodel_outcome_km <- survfit(\n  Surv(time, status) ~ trt,\n  data = weighted,\n  weights = weight\n)\n```\n:::\n\n\n4. **Predict** quantities of interest from your marginal structural model.\n\nNote that because the MSM has already marginalized over $\\vec{X}$, the data to predict are only the treatment values of interest.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nto_predict <- tibble(trt = 1:2)\n```\n:::\n\n\nHow would you write code to predict some survival quantity from your marginal structural model? Sketch a plan before looking at the example code.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Code answer using Weibull.\"}\n# This example code generates survival curves over the first year.\n\n# Predict the shape and scale at each treatment value\npredicted <- to_predict |>\n  mutate(\n    shape = 1 / model_outcome$scale,\n    xb = predict(\n      model_outcome, \n      newdata = to_predict, \n      type = \"linear\"\n    )\n  ) |>\n  # Expand to predict for week 1 to 52\n  uncount(weights = 52) |>\n  mutate(time = rep(1:52, 2)) |>\n  # Calculate survival probabilities\n  mutate(\n    survival = pweibull(\n      time, \n      shape = shape, \n      scale = exp(xb), \n      lower.tail = FALSE\n    )\n  )\n\n# Make a graph\npredicted |>\n  # Modify treatment to make plot easier to read\n  mutate(\n    trt = factor(trt, labels = c(\"Standard\",\"Experimental\")),\n    trt = fct_rev(trt)\n  ) |>\n  ggplot(aes(x = time, y = survival, color = trt)) +\n  geom_line() +\n  labs(\n    x = \"Time in Weeks\", \n    y = \"Survival\", \n    color = \"Treatment\",\n    caption = \"Estimates from Weibull Marginal Structural Model\"\n  )\n```\n\n::: {.cell-output-display}\n![](marginal_structural_model_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Code answer using Kaplan-Meier.\"}\nmodel_outcome_km |>\n  broom::tidy() |>\n  # Modify treatment to make plot easier to read\n  mutate(\n    strata = case_when(\n      strata == \"trt=1\" ~ \"Standard\",\n      strata == \"trt=2\" ~ \"Experimental\"\n    )\n  ) |>\n  filter(time <= 52) |>\n  ggplot(aes(x = time, y = estimate, color = strata)) +\n  geom_line() +\n  labs(\n    x = \"Time in Weeks\", \n    y = \"Survival\", \n    color = \"Treatment\",\n    caption = \"Estimates from Kaplan-Meier Marginal Structural Model\"\n  )\n```\n\n::: {.cell-output-display}\n![](marginal_structural_model_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n",
    "supporting": [
      "marginal_structural_model_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}