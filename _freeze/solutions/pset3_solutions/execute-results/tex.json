{
  "hash": "2f8efb0435177c9fbabd3b1f20ee7663",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Problem Set 3 Solutions\"\nformat: pdf\n---\n\n\n::: {.cell}\n\n:::\n\n\nProblem sets are currently posted on Piazza, but I plan to gather them on this page.\n\n## Problem Set 3\n\nThis problem set practices Kaplan-Meier survival curve estimation and a Weibull model.\n\nThe `survival::veteran` data contain data from a clinical trial involving cancer patients run by the Veteran's Administration. These data are described in Kalbfleisch and Prentice (1980) on p.~60. There are 137 patients, and only 9 are censored before death. \n\n- `status` is 1 for death, 0 for censoring\n- `time` is days of survival\n- `trt` is a randomized chemotherapy test treatment. 1 indicates standard treatment, 2 indicates the test treatment\n\nFor more information see `?survival::veteran`.\n\n1. (10 points) Estimate survival curves by treatment status `trt`, using the Kaplan-Meier method. Visualize the results in a plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkaplan_meier <- survfit(Surv(time, status) ~ trt, data = veteran) |>\n  broom::tidy()\n```\n:::\n\n\n2. (10 points) Estimate survival curves by treatment status `trt`, using a Weibull regression with only this predictor. Visualize the results in a plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- survreg(Surv(time, status) ~ trt, data = veteran, dist = \"weibull\")\n\nto_predict <- veteran |>\n  distinct(trt)\n\nweibull_survival <- to_predict |>\n  mutate(\n    scale = exp(predict(model, newdata = to_predict, type = \"linear\")),\n    alpha = 1 / model$scale\n  ) |>\n  group_by(trt) |>\n  uncount(weight = 100) |>\n  mutate(\n    time = seq(1,500,length.out = 100),\n    s = pweibull(time, shape = alpha, scale = scale, lower.tail = FALSE),\n    method = \"Weibull\"\n  )\n\nweibull_survival |>\n  ggplot(aes(x = time, y = s, color = factor(trt))) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](pset3_solutions_files/figure-pdf/unnamed-chunk-3-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n3. (10 points) Compare: Plot the Weibull and Kaplan-Meier survival curves on the same plot. How do they differ? For ease of comparison, you might use different panels or different plots for each treatment status so that it is easier to compare across models within treatment status.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkaplan_meier |>\n  mutate(method = \"Kaplan-Meier\") |>\n  select(time, s = estimate, trt = strata, method) |>\n  bind_rows(\n    weibull_survival |>\n      mutate(trt = paste0(\"trt=\",trt)) |>\n      select(time, s, trt, method)\n  ) |>\n  ggplot(aes(x = time, y = s, color = method)) +\n  geom_line() +\n  facet_wrap(~trt)\n```\n\n::: {.cell-output-display}\n![](pset3_solutions_files/figure-pdf/unnamed-chunk-4-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n4. (10 points) Plot the estimated Weibull hazard function. Does it increase or decrease with time?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nweibull_survival |>\n  mutate(\n    h = dweibull(time, shape = alpha, scale = scale) / s\n  ) |>\n  ggplot(aes(x = time, y = h, color = factor(trt))) +\n  geom_line() +\n  geom_hline(yintercept = 0)\n```\n\n::: {.cell-output-display}\n![](pset3_solutions_files/figure-pdf/unnamed-chunk-5-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n5. (8 points) In your Weibull results, can you reject the null of an Exponential model?\n\nYes. I can reject the null that `log(scale)` equals 0.\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nsurvreg(formula = Surv(time, status) ~ trt, data = veteran, dist = \"weibull\")\n             Value Std. Error     z      p\n(Intercept) 4.7218     0.3275 14.42 <2e-16\ntrt         0.0478     0.2079  0.23  0.818\nLog(scale)  0.1585     0.0673  2.35  0.019\n\nScale= 1.17 \n\nWeibull distribution\nLoglik(model)= -748.1   Loglik(intercept only)= -748.1\n\tChisq= 0.05 on 1 degrees of freedom, p= 0.82 \nNumber of Newton-Raphson Iterations: 5 \nn= 137 \n```\n\n\n:::\n:::\n\n\n<!-- 5. Fit a Cox model. How does the coefficient on `trt` compare to the ? -->\n\n6. (2 points) Challenge: Construct a confidence interval on each point of your Weibull survival functions and visualize the result. Note that this is quite challenging: you can skip it and still get an A on the problem set. Here are some steps.\n- Define the X matrix at which to make predictions\n- Loop over simulations. In each iteration,\n     - Simulate $\\vec\\beta$ and the `log_scale` parameter from a Multivariate Normal centered at `c(coef(model), log(model$scale))` with variance-covariance matrix `vcov(model)`\n     - Construct the `rweibull` parameter `scale`, $e^{\\vec{X}'\\vec\\beta}$\n     - Construct the `rweibull` parameter `shape`, `1 / exp(log_scale)` where `log_scale` is the simulated value of the log of the `survreg` scale parameter\n     - Simulate survival functions with those parameters\n- At each point of the survival curve, calculate the 2.5 and 97.5 percentiles of the empirical distribution of simulated draws.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nX <- model.matrix( ~ trt, data = to_predict)\npoint_parameters <- c(coef(model), log(model$scale))\n\nsim_parameters <- foreach(rep = 1:1000, .combine = \"rbind\") %do% {\n  parameters_simulated <- mvtnorm::rmvnorm(\n    1,\n    mean = point_parameters,\n    sigma = vcov(model)\n  )\n  to_predict |>\n    mutate(\n      scale = exp(X %*% parameters_simulated[1:2]) |> unname(),\n      shape = 1 / exp(parameters_simulated[3]),\n      sim_index = rep\n    )\n}\nsim_parameters |>\n  group_by(trt, sim_index) |>\n  uncount(weights = 100) |>\n  mutate(\n    time = seq(1,500,length.out = 100),\n    s = pweibull(time, shape = shape, scale = scale, lower.tail = FALSE)\n  ) |>\n  group_by(trt, time) |>\n  summarize(\n    ci.min = quantile(s, .025),\n    ci.max = quantile(s, .975)\n  ) |>\n  left_join(\n    weibull_survival |> select(trt, time, s), by = join_by(trt, time)\n  ) |>\n  ggplot(aes(x = time, y = s, ymin = ci.min, ymax = ci.max)) +\n  geom_line() +\n  geom_ribbon(alpha = .4) +\n  facet_wrap(~trt)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'trt'. You can override using the `.groups`\nargument.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](pset3_solutions_files/figure-pdf/unnamed-chunk-7-1.pdf){fig-pos='H'}\n:::\n:::\n\n",
    "supporting": [
      "pset3_solutions_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}