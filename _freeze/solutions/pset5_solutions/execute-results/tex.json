{
  "hash": "7d08abd09ac60b73e7e05f4591c43aef",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Problem Set 5 Solutions\"\nformat: pdf\n---\n\n\n::: {.cell}\n\n:::\n\n\nThe file `employment_duration.csv` contains information on spells of employment.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemployment_duration <- read_csv(\"https://ilundberg.github.io/eventhistory/assets/employment_duration.csv\")\n```\n:::\n\n\n::: {.cell}\n\n:::\n\n\nAt the start of each employment spell, we observe whether the respondent works `fulltime = TRUE` or `fulltime = FALSE`, where `fulltime` is an indicator of working 40+ hours in at least one week during the first month of the job. This problem set considers a causal question: to what degree does being employed full-time at the start affect the length of the employment spell?\n\nWe will make the simplifying assumptions of ignorable censoring and that selection on observables holds conditional on the following confounder set: `race`, `sex`, `age`, and `education`.\n\nAs context, below are the descriptive Kaplan-Meier survival curves by full-time status (with no confounder adjustment). \n\n::: {.cell}\n::: {.cell-output-display}\n![](pset5_solutions_files/figure-pdf/unnamed-chunk-4-1.pdf)\n:::\n:::\n\n\nAs a concrete data point, the probability of remaining employed for 5 years among those in each treatment group is given below. There is approximately an 8 percentage point difference across treatment conditions.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 x 2\n# Groups:   Treatment_Value [2]\n  Treatment_Value Survives_5_Years\n  <chr>                      <dbl>\n1 fulltime=FALSE             0.154\n2 fulltime=TRUE              0.231\n```\n\n\n:::\n:::\n\n\n1. Estimate a Weibull model for employment duration as a function of the treatment `fulltime` and the confounders `race`, `sex`, `age`, and `education`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- survreg(\n  Surv(time, event = 1 - censored) ~ fulltime + sex + race + age + education,\n  data = employment_duration,\n  dist = \"weibull\"\n)\n```\n:::\n\n\n2. Create two new data frames to make predictions. Each begins as `employment_duration`. In the first data frame, set `fulltime = TRUE` for all cases. In the second data frame, set `fulltime = FALSE` for all cases.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nunder_treatment <- employment_duration |> mutate(fulltime = TRUE)\nunder_control <- employment_duration |> mutate(fulltime = FALSE)\n```\n:::\n\n\n3. In each data frame, use your model to predict the probability of surviving (remaining in the employment spell) for at least 5 years, for every person in the data frame.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredict_survival <- function(model, newdata, time) {\n  if (!all(class(model) == \"survreg\")) {\n    stop(\"Error: This function expects a survreg model.\")\n  }\n  if (model$dist != \"weibull\") {\n    stop(\"Error: This function only supports a Weibull survreg model.\")\n  }\n  if (length(time) != 1) {\n    stop(\"Error: This function expects time of length 1\")\n  }\n  pweibull(\n    q = time, \n    shape = 1 / model$scale, \n    scale = exp(predict(model, newdata = newdata, type = \"linear\")),\n    lower.tail = FALSE\n  )\n}\npredicted_under_treatment <- under_treatment |>\n  mutate(\n    estimate = predict_survival(\n      model = model, \n      newdata = under_treatment, \n      time = 5\n    )\n  )\n\npredicted_under_control <- under_control |>\n  mutate(\n    estimate = predict_survival(\n      model = model, \n      newdata = under_control, \n      time = 5\n    )\n  )\n```\n:::\n\n\n4. Take the average of the predicted probabilities. These are estimates of $\\text{P}(Y^{\\text{fulltime} = \\text{TRUE}} > 5)$ and $\\text{P}(Y^{\\text{fulltime} = \\text{FALSE}} > 5)$. Report each estimate and the difference between them, which is your estimated causal effect. How does it compare to the 8 percentage point descriptive difference?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvival_avg_under_treated <- predicted_under_treatment |> \n  pull(estimate) |>\n  mean() |> \n  print()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.2092174\n```\n\n\n:::\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvival_avg_under_control <- predicted_under_control |> \n  pull(estimate) |>\n  mean() |> \n  print()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.2003279\n```\n\n\n:::\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvival_avg_under_treated - survival_avg_under_control\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.008889526\n```\n\n\n:::\n:::\n\n\n**Note.** This is not part of the assignment because we have already practiced it previously, but worth noting. You can imagine running a loop over many time points and then creating counterfactual survival curves for the population-average survival in each counterfactual scenario. The problem set just chose one time point (time = 5) for illustration.\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.2092174\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.2003279\n```\n\n\n:::\n:::\n",
    "supporting": [
      "pset5_solutions_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}